parameters:
  phpVersion: '7.4.9'

steps:
	- script: |
	   mkdir /tmp/php-build
	   cd /tmp/php-build
	   wget https://www.php.net/distributions/${{ parameters.phpVersion }}.tar.bz2
	   tar -xvjf ${{ parameters.phpVersion }}.tar.bz2
	   cd ${{ parameters.phpVersion }}
      displayName: 'Download and Extract PHP'
    - script: |
        export PATH="/usr/local/opt/bison/bin:$PATH"
        export PKG_CONFIG_PATH="$PKG_CONFIG_PATH:/usr/local/opt/openssl@1.1/lib/pkgconfig"
        export PKG_CONFIG_PATH="$PKG_CONFIG_PATH:/usr/local/opt/krb5/lib/pkgconfig"
        export PKG_CONFIG_PATH="$PKG_CONFIG_PATH:/usr/local/opt/libffi/lib/pkgconfig"
        export PKG_CONFIG_PATH="$PKG_CONFIG_PATH:/usr/local/opt/libxml2/lib/pkgconfig"
        export PKG_CONFIG_PATH="$PKG_CONFIG_PATH:/usr/local/opt/libxslt/lib/pkgconfig"
        export PKG_CONFIG_PATH="$PKG_CONFIG_PATH:/usr/local/opt/zlib/lib/pkgconfig"
        export PKG_CONFIG_PATH="$PKG_CONFIG_PATH:/usr/local/opt/icu4c/lib/pkgconfig"

        ./configure ${{ parameters.configurationParameters }} \
            --disable-all \
            --prefix=/usr/local \
            --enable-sockets \
            --with-config-file-path=/etc \
            --with-config-file-scan-dir=/etc/php.d
      displayName: 'Configure Build'
    - script: |
        export PATH="/usr/local/opt/bison/bin:$PATH"
        make -j$(sysctl -n hw.ncpu) >/dev/null
      displayName: 'Make Build'
    - script: |
        sudo make install
      displayName: 'Install Build'
